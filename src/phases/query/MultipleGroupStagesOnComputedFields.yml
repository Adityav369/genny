SchemaVersion: 2018-07-01
Owner: "@mongodb/query"
Description: |
  This file defines templates to use in workloads exercising multiple group stages on computed
  fields.

InsertDataTemplate:
  Name: InsertData
  Type: Loader
  Threads: 4
  Phases:
    OnlyActiveInPhases:
      Active: {^Parameter: {Name: "active", Default: [0]}}
      NopInPhasesUpTo: {^Parameter: {Name: "nopInPhasesUpTo", Default: 5}}
      PhaseConfig:
        Repeat: 1
        Database: {^Parameter: {Name: "database", Default: test}}
        MultipleThreadsPerCollection: true
        CollectionCount: 1
        Collection: {^Parameter: {Name: "collection", Default: Collection0}}
        DocumentCount: {^Parameter: {Name: "documentCount", Default: 1e6}}
        BatchSize: {^Parameter: {Name: "batchSize", Default: 3000}}
        Document:
          # Since step = 15 ms and documentCount = 1,000,000, the first and last document would be 15,000,000 ms apart (roughly 4 days).
          time: {^IncDate: {start: "2022-01-01", step: 15}}
          symbol: {^Cycle: {ofLength: {^Parameter: {Name: "numGroups", Default: 100}}, fromGenerator: {^RandomString: {length: 6}}}}
          price: {^RandomDouble: {min: 100.0, max: 1000.0}}

QueryTemplate:
  Name: {^Parameter: {Name: "name", Default: MultipleGroupStagesOnComputedFieldsTemplate}}
  Type: CrudActor
  Database: &Database {^Parameter: {Name: "database", Default: test}}
  Threads: {^Parameter: {Name: "threads", Default: 10}}
  Phases:
    OnlyActiveInPhases:
      Active: {^Parameter: {Name: "active", Default: [0]}}
      NopInPhasesUpTo: {^Parameter: {Name: "nopInPhasesUpTo", Default: 5}}
      PhaseConfig:
        Repeat: {^Parameter: {Name: "repeat", Default: 10}}
        Database: *Database
        Collection: {^Parameter: {Name: "collection", Default: Collection0}}
        Operations:
        - OperationMetricsName: {^Parameter: {Name: "operationsMetricsName", Default: MultipleGroupStagesOnComputedFieldsTemplate}}
          OperationName: aggregate
          OperationCommand:
            Pipeline: [{$addFields:
                          {"hourDiff": {$dateDiff: {"startDate": "$time", "endDate": {^Date: "2022-01-04"}, "unit": "hour"}}}},
                          {$match: {"hourDiff": {$lte: 24}}},
                          {$group:
                            {"_id" :
                              { "symbol" : "$symbol" ,
                                "time": { "$dateTrunc" : {"date": "$time", "unit": "minute", "binSize" : 60}}
                              },
                              "open" : {"$first" : "$price"},
                              "close" : {"$last" : "$price"}}
                          },
                          {
                              $addFields : {
                                  "diffPercentage" : {$round : [{$multiply : [100, { $divide : [{$subtract : ["$close", "$open"]}, "$open"] }]}, 2]}
                              }
                          },
                          {
                            $group: {
                                  "_id" : "$_id.time",
                                  "topN": {
                                      $topN: {
                                          "output": ["$_id.symbol", "$diffPercentage", "$close"],
                                          "sortBy" : { "diffPercentage" : -1 },
                                          "n": 3
                                      }
                                  },
                                  "bottomN": {
                                      $bottomN: {
                                          "output": ["$_id.symbol", "$diffPercentage", "$close"],
                                          "sortBy" : { "diffPercentage" : 1 },
                                          "n": 3
                                      }
                                  },
                              }
                          },
                          {
                              $sort : {
                                  "_id" : -1
                              }
                          }]
