SchemaVersion: 2018-07-01
Owner: "@mongodb/query"
Description: |
  The query in this workload has $addFields as the first stage, followed by a dependent $match,
  multiple group stages dependent on computed fields, and a sort stage at the end of the pipeline.

Keywords:
- aggregate
- sbe

GlobalDefaults:
  Database: &Database test
  Collection: &Collection Collection0
  DocumentCount: &DocumentCount 1e6
  NumGroups: &NumGroups 100
  Repeat: &Repeat 10
  Threads: &Threads 1
  MaxPhases: &MaxPhases 3

Actors:
# Clear any pre-existing collection state.
- Name: ClearCollection
  Type: CrudActor
  Database: *Database
  Threads: *Threads
  Phases:
    OnlyActiveInPhases:
      Active: [0]
      NopInPhasesUpTo: *MaxPhases
      PhaseConfig:
        Repeat: 1
        Threads: *Threads
        Collection: *Collection
        Operations:
        - OperationName: drop

- InsertData:
  LoadConfig:
    Path: "../../phases/query/MultipleGroupStagesOnComputedFields.yml"
    Key: InsertDataTemplate
    Parameters:
      active: [1]
      nopInPhasesUpTo: *MaxPhases
      documentCount: *DocumentCount
      numGroups: *NumGroups

# Phase 2: Ensure all data is synced to disk.
- Name: Quiesce
  Type: QuiesceActor
  Threads: 1
  Database: *Database
  Phases:
    OnlyActiveInPhases:
      Active: [2]
      NopInPhasesUpTo: *MaxPhases
      PhaseConfig:
        Repeat: 1
        Threads: 1

- RunQuery:
  LoadConfig:
    Path: "../../phases/query/MultipleGroupStagesOnComputedFields.yml"
    Key: QueryTemplate
    Parameters:
      name: MultipleGroupStagesOnComputedFields
      active: [3]
      nopInPhasesUpTo: *MaxPhases
      repeat: *Repeat
      operationMetricsName: MultipleGroupStagesOnComputedFields

AutoRun:
- When:
    mongodb_setup:
      $eq:
      - standalone
      - standalone-classic-query-engine
      - standalone-all-feature-flags
      - standalone-sbe
    branch_name:
      $neq:
      - v4.0
      - v4.2
      - v4.4
      - v5.0
      - v5.1
      - v5.2
      - v5.3
